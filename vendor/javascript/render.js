import{posToTranslate as e,key2pos as s,translate as o,createEl as t}from"./util.js";import{whitePov as n}from"./board.js";import"./types.js";import"./premove.js";function render(i){const d=n(i),a=e(i.dom.bounds()),c=i.dom.elements.board,r=i.pieces,l=i.animation.current,g=l?l.plan.anims:new Map,f=l?l.plan.fadings:new Map,p=i.draggable.current,m=computeSquareClasses(i),u=new Set,h=new Set,v=new Map,x=new Map;let w,y,b,S,q,C,I,P,M,A;y=c.firstChild;while(y){w=y.cgKey;if(isPieceNode(y)){b=r.get(w);q=g.get(w);C=f.get(w);S=y.cgPiece;if(y.cgDragging&&(!p||p.orig!==w)){y.classList.remove("dragging");o(y,a(s(w),d));y.cgDragging=false}if(!C&&y.cgFading){y.cgFading=false;y.classList.remove("fading")}if(b){if(q&&y.cgAnimating&&S===pieceNameOf(b)){const e=s(w);e[0]+=q[2];e[1]+=q[3];y.classList.add("anim");o(y,a(e,d))}else if(y.cgAnimating){y.cgAnimating=false;y.classList.remove("anim");o(y,a(s(w),d));i.addPieceZIndex&&(y.style.zIndex=posZIndex(s(w),d))}if(S!==pieceNameOf(b)||C&&y.cgFading)if(C&&S===pieceNameOf(C)){y.classList.add("fading");y.cgFading=true}else appendValue(v,S,y);else u.add(w)}else appendValue(v,S,y)}else if(isSquareNode(y)){const e=y.className;m.get(w)===e?h.add(w):appendValue(x,e,y)}y=y.nextSibling}for(const[e,n]of m)if(!h.has(e)){M=x.get(n);A=M&&M.pop();const i=a(s(e),d);if(A){A.cgKey=e;o(A,i)}else{const s=t("square",n);s.cgKey=e;o(s,i);c.insertBefore(s,c.firstChild)}}for(const[e,n]of r){q=g.get(e);if(!u.has(e)){I=v.get(pieceNameOf(n));P=I&&I.pop();if(P){P.cgKey=e;if(P.cgFading){P.classList.remove("fading");P.cgFading=false}const t=s(e);i.addPieceZIndex&&(P.style.zIndex=posZIndex(t,d));if(q){P.cgAnimating=true;P.classList.add("anim");t[0]+=q[2];t[1]+=q[3]}o(P,a(t,d))}else{const r=pieceNameOf(n),l=t("piece",r),g=s(e);l.cgPiece=r;l.cgKey=e;if(q){l.cgAnimating=true;g[0]+=q[2];g[1]+=q[3]}o(l,a(g,d));i.addPieceZIndex&&(l.style.zIndex=posZIndex(g,d));c.appendChild(l)}}}for(const e of v.values())removeNodes(i,e);for(const e of x.values())removeNodes(i,e)}function renderResized(t){const i=n(t),d=e(t.dom.bounds());let a=t.dom.elements.board.firstChild;while(a){(isPieceNode(a)&&!a.cgAnimating||isSquareNode(a))&&o(a,d(s(a.cgKey),i));a=a.nextSibling}}function updateBounds(e){var s,o;const t=e.dom.elements.wrap.getBoundingClientRect();const n=e.dom.elements.container;const i=t.height/t.width;const d=Math.floor(t.width*window.devicePixelRatio/8)*8/window.devicePixelRatio;const a=d*i;n.style.width=d+"px";n.style.height=a+"px";e.dom.bounds.clear();(s=e.addDimensionsCssVarsTo)===null||s===void 0?void 0:s.style.setProperty("---cg-width",d+"px");(o=e.addDimensionsCssVarsTo)===null||o===void 0?void 0:o.style.setProperty("---cg-height",a+"px")}const isPieceNode=e=>e.tagName==="PIECE";const isSquareNode=e=>e.tagName==="SQUARE";function removeNodes(e,s){for(const o of s)e.dom.elements.board.removeChild(o)}function posZIndex(e,s){const o=3;const t=e[1];const n=s?o+7-t:o+t;return`${n}`}const pieceNameOf=e=>`${e.color} ${e.role}`;function computeSquareClasses(e){var s,o,t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const s of e.lastMove)addSquare(n,s,"last-move");e.check&&e.highlight.check&&addSquare(n,e.check,"check");if(e.selected){addSquare(n,e.selected,"selected");if(e.movable.showDests){const i=(s=e.movable.dests)===null||s===void 0?void 0:s.get(e.selected);if(i)for(const s of i)addSquare(n,s,"move-dest"+(e.pieces.has(s)?" oc":""));const d=(t=(o=e.premovable.customDests)===null||o===void 0?void 0:o.get(e.selected))!==null&&t!==void 0?t:e.premovable.dests;if(d)for(const s of d)addSquare(n,s,"premove-dest"+(e.pieces.has(s)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)addSquare(n,e,"current-premove");else e.predroppable.current&&addSquare(n,e.predroppable.current.key,"current-premove");const d=e.exploding;if(d)for(const e of d.keys)addSquare(n,e,"exploding"+d.stage);e.highlight.custom&&e.highlight.custom.forEach(((e,s)=>{addSquare(n,s,e)}));return n}function addSquare(e,s,o){const t=e.get(s);t?e.set(s,`${t} ${o}`):e.set(s,o)}function appendValue(e,s,o){const t=e.get(s);t?t.push(o):e.set(s,[o])}export{render,renderResized,updateBounds};
//# sourceMappingURL=render.js.map
